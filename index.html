<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mermaid Process Visualizer</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs" type="module"></script>
  <style>
    :root {
      color-scheme: light dark;
      --panel-width: clamp(320px, 28vw, 420px);
      --left-panel-offset: calc(var(--panel-width) + 4rem);
      --right-panel-offset: calc(var(--panel-width) + 4rem);
    }

    body[data-left-collapsed='true'] {
      --left-panel-offset: 2rem;
    }

    body[data-right-collapsed='true'] {
      --right-panel-offset: 2rem;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      display: flex;
    }

    main {
      flex: 1;
      position: relative;
      display: flex;
      min-height: 0;
      overflow: hidden;
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.35), transparent 55%),
        radial-gradient(circle at bottom right, rgba(14, 165, 233, 0.25), transparent 50%);
    }

    .diagram-stage {
      position: relative;
      flex: 1;
      min-width: 0;
    }

    .diagram-area {
      position: absolute;
      inset: 0;
      padding: 2rem var(--right-panel-offset) 2rem var(--left-panel-offset);
      overflow: auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .diagram-area svg {
      max-width: min(1400px, 100%);
      height: auto;
    }

    .diagram-area:empty::before {
      content: 'Your diagram will appear here';
      font-size: 1rem;
      color: rgba(226, 232, 240, 0.6);
    }

    .side-panel {
      position: absolute;
      top: 2rem;
      bottom: 2rem;
      width: var(--panel-width);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      border-radius: 24px;
      background: rgba(15, 23, 42, 0.82);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 30px 80px rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(20px);
      z-index: 1;
      min-height: 0;
      transition: transform 0.35s ease;
    }

    .side-panel[data-side='left'] {
      left: 2rem;
    }

    .side-panel[data-side='right'] {
      right: 2rem;
    }

    .side-panel .panel-body {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      height: 100%;
      overflow: auto;
      transition: opacity 0.3s ease;
    }

    .side-panel.is-collapsed .panel-body {
      opacity: 0;
      pointer-events: none;
    }

    .side-panel[data-side='left'].is-collapsed {
      transform: translateX(calc(-100% + 3rem));
    }

    .side-panel[data-side='right'].is-collapsed {
      transform: translateX(calc(100% - 3rem));
    }

    .panel-toggle {
      position: absolute;
      top: 1.25rem;
      width: 2.5rem;
      height: 2.5rem;
      display: grid;
      place-items: center;
      border-radius: 999px;
      z-index: 2;
    }

    .side-panel[data-side='left'] .panel-toggle {
      right: -1.25rem;
    }

    .side-panel[data-side='right'] .panel-toggle {
      left: -1.25rem;
    }

    .info-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .info-header h2 {
      margin: 0;
      font-size: clamp(1.1rem, 2vw, 1.5rem);
      font-weight: 600;
      color: #bfdbfe;
    }

    .info-section {
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
    }

    .info-section h3 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: rgba(226, 232, 240, 0.75);
    }

    .info-list {
      margin: 0;
      padding-left: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      color: rgba(226, 232, 240, 0.75);
      font-size: 0.9rem;
    }

    .info-list li {
      list-style: disc;
    }

    .info-list--legend {
      list-style: none;
      padding-left: 0;
      gap: 0.75rem;
    }

    .info-list--legend li {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      list-style: none;
    }

    .entity-section {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    .entity-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .entity-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      text-transform: none;
      color: #bfdbfe;
    }

    .entity-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .entity-list:empty::before {
      content: attr(data-empty-text);
      font-size: 0.88rem;
      color: rgba(226, 232, 240, 0.55);
    }

    .entity-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.75rem;
      align-items: center;
      padding: 0.65rem 0.75rem;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .entity-input {
      width: 100%;
      border: none;
      background: transparent;
      color: inherit;
      font-size: 0.95rem;
      font-family: inherit;
      line-height: 1.4;
    }

    .entity-input::placeholder {
      color: rgba(226, 232, 240, 0.45);
    }

    .entity-input:focus {
      outline: none;
    }

    .legend-swatch {
      width: 0.85rem;
      height: 0.85rem;
      border-radius: 4px;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.45);
      flex-shrink: 0;
    }

    .legend-swatch--start {
      background: linear-gradient(135deg, #22c55e, #4ade80);
    }

    .legend-swatch--step {
      background: linear-gradient(135deg, #2563eb, #60a5fa);
    }

    .legend-swatch--decision {
      background: linear-gradient(135deg, #f59e0b, #facc15);
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.4rem, 2.3vw, 2rem);
      font-weight: 600;
      color: #93c5fd;
    }

    p {
      margin: 0;
      color: rgba(226, 232, 240, 0.75);
      line-height: 1.5;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    label,
    .field-label {
      font-weight: 600;
      color: #e2e8f0;
    }

    .input-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.4;
      background-color: rgba(15, 23, 42, 0.45);
      color: #f8fafc;
    }

    .input-control:focus {
      outline: 2px solid rgba(59, 130, 246, 0.8);
      outline-offset: 2px;
    }

    .steps-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .steps-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: nowrap;
      justify-content: flex-end;
    }

    .steps-actions .secondary-button {
      white-space: nowrap;
    }

    .steps-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: min(45vh, 360px);
      overflow-y: auto;
      padding-right: 0.25rem;
      scrollbar-gutter: stable both-edges;
    }

    .steps-list::-webkit-scrollbar {
      width: 8px;
    }

    .steps-list::-webkit-scrollbar-track {
      background: rgba(148, 163, 184, 0.15);
      border-radius: 999px;
    }

    .steps-list::-webkit-scrollbar-thumb {
      background: rgba(96, 165, 250, 0.45);
      border-radius: 999px;
    }

    .steps-list::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.6);
    }

    .steps-list:empty::before {
      content: 'Add steps or decisions to expand the journey between start and end.';
      font-size: 0.9rem;
      color: rgba(226, 232, 240, 0.55);
    }

    .step-row {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 0.65rem 0.75rem;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .step-header {
      display: grid;
      grid-template-columns: auto auto minmax(0, 1fr) auto;
      gap: 0.75rem;
      align-items: center;
    }

    .step-body {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .step-row--process .step-body {
      padding-left: calc(4.5rem + 1.5rem);
    }

    .step-row--process.step-collapsed .step-body {
      display: none;
    }

    .step-row--decision {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
      padding: 0.9rem 0.85rem;
    }

    .step-row[data-type='decision'] {
      border-color: rgba(250, 204, 21, 0.5);
      background: rgba(250, 204, 21, 0.12);
      color: rgba(250, 250, 250, 0.92);
    }

    .step-row[data-type='decision'] .step-label {
      color: rgba(250, 250, 250, 0.85);
    }

    .decision-header {
      display: grid;
      grid-template-columns: auto auto auto 1fr auto;
      gap: 0.75rem;
      align-items: center;
    }

    .drag-handle {
      cursor: grab;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .step-row.is-dragging {
      opacity: 0.55;
      border-style: dashed;
    }

    .decision-toggle {
      font-size: 1.05rem;
    }

    .decision-toggle span {
      display: inline-block;
      transition: transform 0.2s ease;
    }

    .step-row--decision.decision-collapsed .decision-toggle span {
      transform: rotate(-90deg);
    }

    .step-toggle {
      font-size: 1.05rem;
    }

    .step-toggle span {
      display: inline-block;
      transition: transform 0.2s ease;
    }

    .step-row--process.step-collapsed .step-toggle span {
      transform: rotate(-90deg);
    }

    .decision-branches {
      display: grid;
      gap: 0.75rem;
    }

    .step-row--decision.decision-collapsed .decision-branches {
      display: none;
    }

    .branch-section {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      padding: 0.75rem;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .branch-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }

    .branch-label {
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: rgba(226, 232, 240, 0.75);
    }

    .branch-steps {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .branch-step {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      grid-template-rows: auto auto;
      column-gap: 0.6rem;
      row-gap: 0.45rem;
      align-items: center;
      padding: 0.5rem 0.6rem;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .branch-step-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: rgba(226, 232, 240, 0.8);
    }

    .branch-step-input {
      width: 100%;
      border: none;
      background: transparent;
      color: inherit;
      padding: 0;
    }

    .branch-step-input::placeholder {
      color: rgba(226, 232, 240, 0.45);
    }

    .branch-step-input:focus {
      outline: none;
    }

    .assignment-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
    }

    .assignment-row--compact {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }

    .branch-step .assignment-row {
      grid-column: 1 / -1;
    }

    .assignment-field {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .assignment-field-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(226, 232, 240, 0.7);
    }

    .assignment-select {
      width: 100%;
      padding: 0.45rem 0.65rem;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.5);
      color: inherit;
      font-family: inherit;
      font-size: 0.85rem;
    }

    .assignment-select:focus {
      outline: 2px solid rgba(59, 130, 246, 0.75);
      outline-offset: 2px;
    }

    .assignment-select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .step-row[data-type='decision'] .assignment-field-label {
      color: rgba(250, 250, 250, 0.75);
    }

    .step-row[data-type='decision'] .assignment-select {
      border-color: rgba(245, 158, 11, 0.4);
      background: rgba(30, 41, 59, 0.55);
    }

    .branch-footer {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: rgba(226, 232, 240, 0.7);
    }

    .branch-target {
      width: 100%;
      padding: 0.45rem 0.75rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.45);
      color: inherit;
      font-size: 0.85rem;
      font-family: inherit;
    }

    .step-label {
      font-weight: 600;
      font-size: 0.9rem;
      color: rgba(226, 232, 240, 0.85);
      min-width: 64px;
    }

    .step-input {
      width: 100%;
      border: none;
      background: transparent;
      color: inherit;
      padding: 0;
    }

    .step-input::placeholder {
      color: rgba(226, 232, 240, 0.45);
    }

    .step-input:focus {
      outline: none;
    }

    .icon-button {
      display: grid;
      place-items: center;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.6);
      color: rgba(226, 232, 240, 0.8);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .icon-button:hover {
      background: rgba(59, 130, 246, 0.2);
      transform: translateY(-1px);
    }

    .secondary-button {
      padding: 0.55rem 1.1rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: transparent;
      color: #bfdbfe;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .secondary-button:hover {
      background: rgba(59, 130, 246, 0.2);
      color: #f8fafc;
    }

    .helper-text {
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.6);
    }

    .panel-footer {
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.65);
      text-align: center;
    }

    .panel-footer a {
      color: inherit;
    }

    @media (max-width: 960px) {
      main {
        flex-direction: column;
      }

      :root {
        --left-panel-offset: 1.5rem;
        --right-panel-offset: 1.5rem;
      }

      .diagram-area {
        position: relative;
        padding: 1.5rem;
        min-height: 55vh;
      }

      .side-panel {
        position: relative;
        inset: auto;
        width: auto;
        margin: 1.5rem;
        padding: 1.5rem;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.55);
        max-height: none;
        transform: none !important;
      }

      .side-panel .panel-body {
        opacity: 1 !important;
        pointer-events: auto;
      }

      .panel-toggle {
        display: none;
      }

      .steps-list {
        max-height: 40vh;
      }
    }

    @media (prefers-color-scheme: light) {
      body {
        background: #f1f5f9;
        color: #0f172a;
      }

      main {
        background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.2), transparent 55%),
          radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.18), transparent 50%);
      }

      .side-panel {
        background: rgba(255, 255, 255, 0.92);
        border-color: rgba(148, 163, 184, 0.35);
        box-shadow: 0 35px 80px rgba(59, 130, 246, 0.22);
        color: #0f172a;
      }

      h1 {
        color: #1d4ed8;
      }

      p,
      label,
      .field-label,
      .panel-footer {
        color: rgba(15, 23, 42, 0.75);
      }

      .input-control {
        background-color: rgba(241, 245, 249, 0.85);
        color: #0f172a;
        border-color: rgba(148, 163, 184, 0.4);
      }

      .steps-list:empty::before {
        color: rgba(15, 23, 42, 0.55);
      }

      .steps-list::-webkit-scrollbar-track {
        background: rgba(148, 163, 184, 0.25);
      }

      .steps-list::-webkit-scrollbar-thumb {
        background: rgba(59, 130, 246, 0.45);
      }

      .step-row {
        background: rgba(241, 245, 249, 0.9);
        border-color: rgba(148, 163, 184, 0.4);
      }

      .step-row[data-type='decision'] {
        background: rgba(253, 230, 138, 0.35);
        border-color: rgba(245, 158, 11, 0.45);
        color: rgba(120, 53, 15, 0.85);
      }

      .step-label {
        color: rgba(15, 23, 42, 0.7);
      }

      .step-row[data-type='decision'] .step-label {
        color: rgba(146, 64, 14, 0.8);
      }

      .branch-section {
        background: rgba(255, 255, 255, 0.88);
        border-color: rgba(148, 163, 184, 0.35);
      }

      .branch-label {
        color: rgba(15, 23, 42, 0.6);
      }

      .branch-step {
        background: rgba(241, 245, 249, 0.85);
        border-color: rgba(148, 163, 184, 0.3);
      }

      .branch-step-label {
        color: rgba(15, 23, 42, 0.65);
      }

      .branch-step-input::placeholder {
        color: rgba(15, 23, 42, 0.45);
      }

      .branch-footer {
        color: rgba(15, 23, 42, 0.6);
      }

      .branch-target {
        background: rgba(241, 245, 249, 0.85);
        border-color: rgba(148, 163, 184, 0.35);
        color: #0f172a;
      }

      .assignment-field-label {
        color: rgba(15, 23, 42, 0.6);
      }

      .step-row[data-type='decision'] .assignment-field-label {
        color: rgba(146, 64, 14, 0.75);
      }

      .assignment-select {
        background: rgba(241, 245, 249, 0.88);
        border-color: rgba(148, 163, 184, 0.35);
        color: #0f172a;
      }

      .step-row[data-type='decision'] .assignment-select {
        background: rgba(253, 230, 138, 0.25);
        border-color: rgba(245, 158, 11, 0.45);
        color: rgba(120, 53, 15, 0.85);
      }

      .assignment-select:disabled {
        background: rgba(226, 232, 240, 0.6);
        color: rgba(15, 23, 42, 0.5);
      }

      .info-header h2 {
        color: #1d4ed8;
      }

      .info-section h3,
      .info-list {
        color: rgba(15, 23, 42, 0.65);
      }

      .legend-swatch {
        box-shadow: 0 0 0 2px rgba(148, 163, 184, 0.35);
      }

      .step-input::placeholder {
        color: rgba(15, 23, 42, 0.45);
      }

      .icon-button {
        background: rgba(148, 163, 184, 0.2);
        color: rgba(15, 23, 42, 0.75);
        border-color: rgba(148, 163, 184, 0.4);
      }

      .icon-button:hover {
        background: rgba(37, 99, 235, 0.12);
      }

      .secondary-button {
        border-color: rgba(148, 163, 184, 0.5);
        color: #1d4ed8;
      }

      .secondary-button:hover {
        background: rgba(59, 130, 246, 0.15);
        color: #1e3a8a;
      }

      .entity-header h3 {
        color: #1d4ed8;
      }

      .entity-list:empty::before {
        color: rgba(15, 23, 42, 0.45);
      }

      .entity-row {
        background: rgba(241, 245, 249, 0.88);
        border-color: rgba(148, 163, 184, 0.4);
      }

      .entity-input {
        color: #0f172a;
      }

      .entity-input::placeholder {
        color: rgba(15, 23, 42, 0.45);
      }

      .helper-text {
        color: rgba(15, 23, 42, 0.55);
      }

    }
  </style>
</head>
<body>
  <main>
    <aside class="side-panel info-panel" data-side="left">
      <button class="icon-button panel-toggle" type="button" aria-expanded="true" aria-controls="insights-panel">
        <span aria-hidden="true">⟨</span>
        <span class="visually-hidden">Toggle organization panel</span>
      </button>
      <div class="panel-body" id="insights-panel" role="region" aria-label="Organization workspace">
        <header class="info-header">
          <h2>Organization context</h2>
          <p id="org-summary">Start by adding departments and roles so your flow mirrors real teams.</p>
        </header>
        <section class="info-section entity-section" aria-labelledby="departments-title">
          <div class="entity-header">
            <h3 id="departments-title">Departments</h3>
            <button id="add-department" class="secondary-button" type="button">Add department</button>
          </div>
          <div
            id="department-list"
            class="entity-list"
            data-empty-text="Add departments to capture who owns each phase."
            role="list"
            aria-labelledby="departments-title"
          ></div>
          <p class="helper-text">Use departments to highlight which teams drive each milestone.</p>
        </section>
        <section class="info-section entity-section" aria-labelledby="roles-title">
          <div class="entity-header">
            <h3 id="roles-title">Roles</h3>
            <button id="add-role" class="secondary-button" type="button">Add role</button>
          </div>
          <div
            id="role-list"
            class="entity-list"
            data-empty-text="Record the key roles collaborating in this journey."
            role="list"
            aria-labelledby="roles-title"
          ></div>
          <p class="helper-text">Pair roles with steps to clarify ownership and expectations.</p>
        </section>
      </div>
    </aside>
    <div class="diagram-stage">
      <div id="diagram" class="diagram-area"></div>
    </div>
    <aside class="side-panel controls-panel" data-side="right">
      <button class="icon-button panel-toggle" type="button" aria-expanded="true" aria-controls="builder-panel">
        <span aria-hidden="true">⟩</span>
        <span class="visually-hidden">Toggle builder panel</span>
      </button>
      <div class="panel-body" id="builder-panel" role="region" aria-label="Process builder controls">
        <header>
          <h1>Mermaid Process Visualizer</h1>
          <p>Describe your process steps and instantly render them across the canvas.</p>
        </header>
        <div class="field-group">
          <label for="start-text">Start step</label>
          <input id="start-text" class="input-control" type="text" placeholder="Name your starting point" value="Kickoff" />
        </div>
        <div class="field-group">
          <div class="steps-header">
            <span class="field-label">Process steps</span>
            <div class="steps-actions">
              <button id="add-step" class="secondary-button" type="button">Add step</button>
              <button id="add-decision" class="secondary-button" type="button">Add Decision</button>
            </div>
          </div>
          <div id="steps-list" class="steps-list" role="list"></div>
          <p class="helper-text">Each step or decision will appear between the start and end circles.</p>
        </div>
        <div class="field-group">
          <label for="end-text">End step</label>
          <input id="end-text" class="input-control" type="text" placeholder="Name the finish line" value="Launch" />
        </div>
        <div class="panel-footer">
          Built with <a href="https://mermaid.js.org" target="_blank" rel="noopener noreferrer">Mermaid</a>
        </div>
      </div>
    </aside>
  </main>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    const diagram = document.getElementById('diagram');
    const startInput = document.getElementById('start-text');
    const endInput = document.getElementById('end-text');
    const addStepButton = document.getElementById('add-step');
    const addDecisionButton = document.getElementById('add-decision');
    const stepsList = document.getElementById('steps-list');
    const addDepartmentButton = document.getElementById('add-department');
    const departmentList = document.getElementById('department-list');
    const addRoleButton = document.getElementById('add-role');
    const roleList = document.getElementById('role-list');
    const orgSummary = document.getElementById('org-summary');
    const body = document.body;
    const panelToggles = document.querySelectorAll('.panel-toggle');
    let draggedStepRow = null;
    const entityCounters = { department: 0, role: 0 };

    body.dataset.leftCollapsed = 'false';
    body.dataset.rightCollapsed = 'false';

    function setPanelToggleState(toggle, side, collapsed) {
      const icon = toggle.querySelector('span[aria-hidden="true"]');
      const expandedLabel = side === 'left' ? 'organization panel' : 'builder panel';
      if (icon) {
        if (side === 'left') {
          icon.textContent = collapsed ? '⟩' : '⟨';
        } else {
          icon.textContent = collapsed ? '⟨' : '⟩';
        }
      }

      toggle.setAttribute('aria-expanded', String(!collapsed));
      toggle.setAttribute('aria-label', `${collapsed ? 'Expand' : 'Collapse'} ${expandedLabel}`);
    }

    panelToggles.forEach((toggle) => {
      const panel = toggle.closest('.side-panel');
      if (!panel) {
        return;
      }

      const side = panel.dataset.side === 'left' ? 'left' : 'right';
      setPanelToggleState(toggle, side, panel.classList.contains('is-collapsed'));

      toggle.addEventListener('click', () => {
        const collapsed = panel.classList.toggle('is-collapsed');
        setPanelToggleState(toggle, side, collapsed);
        if (side === 'left') {
          body.dataset.leftCollapsed = String(collapsed);
        } else {
          body.dataset.rightCollapsed = String(collapsed);
        }
      });
    });

    function updateOrganizationSummary() {
      const countFilledEntries = (container) => {
        if (!container) {
          return 0;
        }
        return Array.from(container.querySelectorAll('.entity-input')).filter((input) => input.value.trim().length > 0)
          .length;
      };

      const departmentCount = countFilledEntries(departmentList);
      const roleCount = countFilledEntries(roleList);

      if (orgSummary) {
        if (departmentCount === 0 && roleCount === 0) {
          orgSummary.textContent = 'Start by adding departments and roles so your flow mirrors real teams.';
        } else {
          const parts = [];
          if (departmentCount > 0) {
            parts.push(`${departmentCount} ${departmentCount === 1 ? 'department' : 'departments'}`);
          }
          if (roleCount > 0) {
            parts.push(`${roleCount} ${roleCount === 1 ? 'role' : 'roles'}`);
          }
          orgSummary.textContent = `Tracking ${parts.join(' and ')} for this journey.`;
        }
      }

      updateAssignmentOptions();
      renderDiagram();
    }

    function updateAssignmentOptions() {
      const getEntityEntries = (type) => {
        const container = type === 'department' ? departmentList : roleList;
        if (!container) {
          return [];
        }

        return Array.from(container.querySelectorAll('.entity-row'))
          .map((row) => {
            const id = row.dataset.entityId;
            if (!id) {
              return null;
            }
            const input = row.querySelector('.entity-input');
            const order = Number(row.dataset.entityOrder) || 0;
            const fallbackPrefix = type === 'department' ? 'Department' : 'Role';
            const fallbackLabel = order > 0 ? `${fallbackPrefix} ${order}` : fallbackPrefix;
            const label = (input?.value || '').trim() || fallbackLabel;
            return { id, label };
          })
          .filter(Boolean);
      };

      const updateSelect = (select, entries, type) => {
        const previousValue = select.value;
        while (select.firstChild) {
          select.removeChild(select.firstChild);
        }

        const typeLabel = type === 'department' ? 'department' : 'role';
        const pluralLabel = type === 'department' ? 'departments' : 'roles';

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent =
          entries.length === 0 ? `Add ${pluralLabel} to assign` : `Unassigned ${typeLabel}`;
        select.appendChild(placeholder);

        entries.forEach(({ id, label }) => {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = label;
          select.appendChild(option);
        });

        if (entries.some(({ id }) => id === previousValue)) {
          select.value = previousValue;
        } else {
          select.value = '';
        }

        select.disabled = entries.length === 0;
      };

      const departmentEntries = getEntityEntries('department');
      const roleEntries = getEntityEntries('role');

      stepsList
        .querySelectorAll('.assignment-select[data-type="department"]')
        .forEach((select) => updateSelect(select, departmentEntries, 'department'));

      stepsList
        .querySelectorAll('.assignment-select[data-type="role"]')
        .forEach((select) => updateSelect(select, roleEntries, 'role'));
    }

    function createAssignmentSelect(type, contextLabel) {
      const select = document.createElement('select');
      select.className = 'assignment-select';
      select.dataset.type = type;
      select.setAttribute('aria-label', `Assign ${type} for this ${contextLabel}`);
      select.addEventListener('change', renderDiagram);
      return select;
    }

    function createAssignmentField(type, context) {
      const field = document.createElement('label');
      field.className = 'assignment-field';

      const fieldLabel = document.createElement('span');
      fieldLabel.className = 'assignment-field-label';
      fieldLabel.textContent = type === 'department' ? 'Department' : 'Role';
      field.appendChild(fieldLabel);

      const select = createAssignmentSelect(type, context);
      field.appendChild(select);

      return field;
    }

    function createAssignmentRow(options = {}) {
      const { context = 'step', variant } = options;
      const contextLabel =
        context === 'decision' ? 'decision' : context === 'branch' ? 'branch step' : 'step';

      const row = document.createElement('div');
      row.className = 'assignment-row';
      if (variant) {
        row.classList.add(`assignment-row--${variant}`);
      }

      const departmentField = createAssignmentField('department', contextLabel);
      row.appendChild(departmentField);

      const roleField = createAssignmentField('role', contextLabel);
      row.appendChild(roleField);

      return row;
    }

    mermaid.initialize({
      startOnLoad: false,
      securityLevel: 'strict',
      theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default'
    });

    function sanitizeLabel(raw, fallback) {
      const safe = (raw ?? '').trim() || fallback;
      return safe
        .replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"')
        .replace(/\[/g, '\\[')
        .replace(/\]/g, '\\]')
        .replace(/\(/g, '\\(')
        .replace(/\)/g, '\\)')
        .replace(/\{/g, '\\{')
        .replace(/\}/g, '\\}')
        .replace(/&/g, '\\&')
        .replace(/</g, '\\<')
        .replace(/>/g, '\\>');
    }

    function collectAssignments(container) {
      if (!container) {
        return { department: null, role: null };
      }

      const assignment = { department: null, role: null };

      const departmentSelect = container.querySelector('.assignment-select[data-type="department"]');
      if (departmentSelect && departmentSelect.value) {
        const option = departmentSelect.selectedOptions?.[0];
        const text = option?.textContent?.trim();
        if (text) {
          assignment.department = sanitizeLabel(text, text);
        }
      }

      const roleSelect = container.querySelector('.assignment-select[data-type="role"]');
      if (roleSelect && roleSelect.value) {
        const option = roleSelect.selectedOptions?.[0];
        const text = option?.textContent?.trim();
        if (text) {
          assignment.role = sanitizeLabel(text, text);
        }
      }

      return assignment;
    }

    function createDragHandle(context = 'item') {
      const handle = document.createElement('button');
      handle.type = 'button';
      handle.className = 'icon-button drag-handle';
      handle.innerHTML = '<span aria-hidden="true">☰</span>';
      handle.setAttribute('aria-label', `Reorder ${context}`);
      return handle;
    }

    function enableRowDrag(row, handle) {
      row.draggable = true;
      let handleActive = false;

      if (handle) {
        const resetHandleState = () => {
          handleActive = false;
        };

        const activateHandleState = () => {
          handleActive = true;
        };

        handle.addEventListener('pointerdown', activateHandleState);
        handle.addEventListener('pointerup', resetHandleState);
        handle.addEventListener('pointerleave', resetHandleState);
        handle.addEventListener('lostpointercapture', resetHandleState);
        handle.addEventListener('blur', resetHandleState);

        handle.addEventListener('mousedown', activateHandleState);
        handle.addEventListener('mouseup', resetHandleState);
        handle.addEventListener('mouseleave', resetHandleState);
      }

      row.addEventListener('dragstart', (event) => {
        if (handle && !handleActive) {
          event.preventDefault();
          return;
        }
        handleActive = false;
        draggedStepRow = row;
        row.classList.add('is-dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', row.dataset.entryId || '');
      });

      row.addEventListener('dragend', () => {
        if (draggedStepRow === row) {
          row.classList.remove('is-dragging');
          draggedStepRow = null;
          updateStepLabels();
          renderDiagram();
        }
      });
    }

    function updateStepLabels() {
      const rows = Array.from(stepsList.querySelectorAll('.step-row'));
      let stepCount = 0;
      let decisionCount = 0;

      rows.forEach((row) => {
        const label = row.querySelector('.step-label');
        const input = row.querySelector('.step-input');
        const type = row.dataset.type === 'decision' ? 'decision' : 'process';
        const dragHandle = row.querySelector('.drag-handle');

        if (type === 'decision') {
          decisionCount += 1;
          const entryId = `decision${decisionCount}`;
          row.dataset.entryId = entryId;
          if (label) {
            label.textContent = `Decision ${decisionCount}`;
          }
          if (input) {
            input.placeholder = `Describe decision ${decisionCount}`;
          }
          if (dragHandle) {
            dragHandle.setAttribute('aria-label', `Reorder decision ${decisionCount}`);
          }
          updateBranchStepLabels(row, 'yes');
          updateBranchStepLabels(row, 'no');
        } else {
          stepCount += 1;
          const entryId = `step${stepCount}`;
          row.dataset.entryId = entryId;
          if (label) {
            label.textContent = `Step ${stepCount}`;
          }
          if (input) {
            input.placeholder = `Describe step ${stepCount}`;
          }
          if (dragHandle) {
            dragHandle.setAttribute('aria-label', `Reorder step ${stepCount}`);
          }
          const toggle = row.querySelector('.step-toggle');
          if (toggle) {
            const isCollapsed = row.classList.contains('step-collapsed');
            toggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
            toggle.setAttribute(
              'aria-label',
              `${isCollapsed ? 'Expand' : 'Collapse'} Step ${stepCount} details`
            );
          }
        }
      });

      updateBranchTargets();
    }

    function updateBranchStepLabels(decisionRow, branchType) {
      const steps = Array.from(
        decisionRow.querySelectorAll(`.branch-steps[data-branch="${branchType}"] .branch-step`)
      );
      const branchName = branchType === 'yes' ? 'Yes' : 'No';

      steps.forEach((stepRow, index) => {
        const label = stepRow.querySelector('.branch-step-label');
        const input = stepRow.querySelector('.branch-step-input');
        if (label) {
          label.textContent = `${branchName} ${index + 1}`;
        }
        if (input) {
          input.placeholder = `Describe ${branchName.toLowerCase()} path ${index + 1}`;
        }
      });
    }

    function updateBranchTargets() {
      const rows = Array.from(stepsList.querySelectorAll('.step-row'));
      const entries = rows
        .map((row) => {
          const entryId = row.dataset.entryId;
          if (!entryId) {
            return null;
          }
          const input = row.querySelector('.step-input');
          const label = row.querySelector('.step-label');
          const text = (input?.value || '').trim();
          const fallback = label?.textContent?.trim() || entryId;
          return { id: entryId, label: text || fallback };
        })
        .filter(Boolean);

      stepsList.querySelectorAll('.branch-target').forEach((select) => {
        const previousValue = select.value;
        while (select.firstChild) {
          select.removeChild(select.firstChild);
        }

        const finishOption = document.createElement('option');
        finishOption.value = 'finish';
        finishOption.textContent = 'Finish';
        select.appendChild(finishOption);

        const parentRow = select.closest('.step-row');

        entries.forEach(({ id, label }) => {
          if (parentRow && parentRow.dataset.entryId === id) {
            return;
          }
          const option = document.createElement('option');
          option.value = id;
          option.textContent = label;
          select.appendChild(option);
        });

        const availableValues = Array.from(select.options).map((option) => option.value);
        if (availableValues.includes(previousValue)) {
          select.value = previousValue;
        } else {
          select.value = 'finish';
        }
      });
    }

    function handleInputChange() {
      updateBranchTargets();
      renderDiagram();
    }

    function createRemoveButton(onRemove, label = 'Remove item', options = {}) {
      const { skipDiagramUpdate = false } = options;
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'icon-button';
      button.innerHTML = '<span aria-hidden="true">&times;</span>';
      button.setAttribute('aria-label', label);
      button.addEventListener('click', () => {
        onRemove();
        if (!skipDiagramUpdate) {
          updateStepLabels();
          renderDiagram();
        }
      });
      return button;
    }

    function createEntityRow(type, value = '') {
      const row = document.createElement('div');
      row.className = 'entity-row';
      row.dataset.entityType = type;
      row.setAttribute('role', 'listitem');

      const counterKey = type === 'department' ? 'department' : 'role';
      entityCounters[counterKey] += 1;
      const entityId = `${counterKey}-${entityCounters[counterKey]}`;
      row.dataset.entityId = entityId;
      row.dataset.entityOrder = String(entityCounters[counterKey]);

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'entity-input';
      input.placeholder = type === 'department' ? 'Name the department' : 'Name the role';
      input.value = value;
      input.setAttribute('aria-label', type === 'department' ? 'Department name' : 'Role name');
      input.addEventListener('input', updateOrganizationSummary);
      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          const newRow = appendEntityRow(type);
          newRow?.querySelector('.entity-input')?.focus();
        }
      });
      row.appendChild(input);

      const removeButton = createRemoveButton(
        () => {
          row.remove();
          updateOrganizationSummary();
        },
        type === 'department' ? 'Remove department' : 'Remove role',
        { skipDiagramUpdate: true }
      );
      row.appendChild(removeButton);

      return row;
    }

    function appendEntityRow(type, value = '') {
      const container = type === 'department' ? departmentList : roleList;
      if (!container) {
        return null;
      }

      const row = createEntityRow(type, value);
      container.appendChild(row);
      updateOrganizationSummary();
      return row;
    }

    if (addDepartmentButton) {
      addDepartmentButton.addEventListener('click', () => {
        const row = appendEntityRow('department');
        const input = row?.querySelector('.entity-input');
        if (input) {
          requestAnimationFrame(() => input.focus());
        }
      });
    }

    if (addRoleButton) {
      addRoleButton.addEventListener('click', () => {
        const row = appendEntityRow('role');
        const input = row?.querySelector('.entity-input');
        if (input) {
          requestAnimationFrame(() => input.focus());
        }
      });
    }

    if (departmentList && departmentList.childElementCount === 0) {
      ['Operations', 'Customer Success'].forEach((name) => {
        appendEntityRow('department', name);
      });
    }

    if (roleList && roleList.childElementCount === 0) {
      ['Process Owner', 'Reviewer'].forEach((name) => {
        appendEntityRow('role', name);
      });
    }

    updateOrganizationSummary();

    function createBranchStepRow(branchType, value = '') {
      const stepRow = document.createElement('div');
      stepRow.className = 'branch-step';
      stepRow.dataset.branch = branchType;

      const label = document.createElement('span');
      label.className = 'branch-step-label';
      label.textContent = branchType === 'yes' ? 'Yes' : 'No';
      stepRow.appendChild(label);

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'branch-step-input';
      input.value = value;
      input.placeholder = branchType === 'yes' ? 'Describe yes path' : 'Describe no path';
      input.addEventListener('input', handleInputChange);
      stepRow.appendChild(input);

      const removeButton = createRemoveButton(() => {
        stepRow.remove();
      }, 'Remove branch step');
      stepRow.appendChild(removeButton);

      const assignmentRow = createAssignmentRow({ context: 'branch', variant: 'compact' });
      stepRow.appendChild(assignmentRow);

      return stepRow;
    }

    function createBranchSection(branchType) {
      const section = document.createElement('div');
      section.className = 'branch-section';
      section.dataset.branch = branchType;

      const header = document.createElement('div');
      header.className = 'branch-header';

      const label = document.createElement('span');
      label.className = 'branch-label';
      label.textContent = branchType === 'yes' ? 'Yes branch' : 'No branch';
      header.appendChild(label);

      const addButton = document.createElement('button');
      addButton.type = 'button';
      addButton.className = 'secondary-button';
      addButton.textContent = 'Add step';
      addButton.addEventListener('click', () => {
        const stepsContainer = section.querySelector('.branch-steps');
        const newStep = createBranchStepRow(branchType);
        stepsContainer.appendChild(newStep);
        updateStepLabels();
        updateAssignmentOptions();
        renderDiagram();
        const input = newStep.querySelector('.branch-step-input');
        if (input) {
          input.focus();
        }
      });
      header.appendChild(addButton);

      section.appendChild(header);

      const stepsContainer = document.createElement('div');
      stepsContainer.className = 'branch-steps';
      stepsContainer.dataset.branch = branchType;
      section.appendChild(stepsContainer);

      const footer = document.createElement('div');
      footer.className = 'branch-footer';

      const footerLabel = document.createElement('span');
      footerLabel.className = 'branch-label';
      footerLabel.textContent = 'Close on';
      footer.appendChild(footerLabel);

      const targetSelect = document.createElement('select');
      targetSelect.className = 'branch-target';
      targetSelect.dataset.branch = branchType;
      targetSelect.addEventListener('change', renderDiagram);
      const finishOption = document.createElement('option');
      finishOption.value = 'finish';
      finishOption.textContent = 'Finish';
      targetSelect.appendChild(finishOption);
      footer.appendChild(targetSelect);

      section.appendChild(footer);

      return section;
    }

    function createStepRow(value = '', type = 'process') {
      const row = document.createElement('div');
      row.className = 'step-row';
      row.setAttribute('role', 'listitem');
      row.dataset.type = type === 'decision' ? 'decision' : 'process';

      if (row.dataset.type === 'decision') {
        row.classList.add('step-row--decision');

        const header = document.createElement('div');
        header.className = 'decision-header';

        const handle = createDragHandle('decision');
        header.appendChild(handle);

        const toggle = document.createElement('button');
        toggle.type = 'button';
        toggle.className = 'icon-button decision-toggle';
        toggle.innerHTML = '<span aria-hidden="true">▾</span>';
        toggle.setAttribute('aria-expanded', 'true');
        toggle.setAttribute('aria-label', 'Collapse decision branches');
        header.appendChild(toggle);

        const label = document.createElement('span');
        label.className = 'step-label';
        label.textContent = 'Decision';
        header.appendChild(label);

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'input-control step-input';
        input.value = value;
        input.placeholder = 'Describe the decision';
        input.addEventListener('input', handleInputChange);
        header.appendChild(input);

        const removeButton = createRemoveButton(() => {
          row.remove();
        }, 'Remove decision');
        header.appendChild(removeButton);

        toggle.addEventListener('click', () => {
          const isCollapsed = row.classList.toggle('decision-collapsed');
          toggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
          toggle.setAttribute(
            'aria-label',
            isCollapsed ? 'Expand decision branches' : 'Collapse decision branches'
          );
        });

        enableRowDrag(row, handle);

        row.appendChild(header);

        const assignmentRow = createAssignmentRow({ context: 'decision' });
        row.appendChild(assignmentRow);

        const branches = document.createElement('div');
        branches.className = 'decision-branches';
        branches.appendChild(createBranchSection('yes'));
        branches.appendChild(createBranchSection('no'));
        row.appendChild(branches);

        return row;
      }

      row.classList.add('step-row--process');

      const header = document.createElement('div');
      header.className = 'step-header';
      row.appendChild(header);

      const handle = createDragHandle('step');
      header.appendChild(handle);
      enableRowDrag(row, handle);

      const toggle = document.createElement('button');
      toggle.type = 'button';
      toggle.className = 'icon-button step-toggle';
      toggle.innerHTML = '<span aria-hidden="true">▾</span>';
      toggle.setAttribute('aria-expanded', 'true');
      toggle.setAttribute('aria-label', 'Collapse step details');
      header.appendChild(toggle);

      const label = document.createElement('span');
      label.className = 'step-label';
      label.textContent = 'Step';
      header.appendChild(label);

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'input-control step-input';
      input.value = value;
      input.placeholder = 'Describe the step';
      input.addEventListener('input', handleInputChange);
      header.appendChild(input);

      const removeButton = createRemoveButton(() => {
        row.remove();
      });
      header.appendChild(removeButton);

      const body = document.createElement('div');
      body.className = 'step-body';
      row.appendChild(body);

      const assignmentRow = createAssignmentRow({ context: 'step' });
      body.appendChild(assignmentRow);

      const updateToggleLabel = (isCollapsed) => {
        const labelText = label.textContent?.trim() || 'Step';
        toggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
        toggle.setAttribute(
          'aria-label',
          `${isCollapsed ? 'Expand' : 'Collapse'} ${labelText} details`
        );
      };

      toggle.addEventListener('click', () => {
        const isCollapsed = row.classList.toggle('step-collapsed');
        updateToggleLabel(isCollapsed);
      });

      updateToggleLabel(false);

      return row;
    }

    stepsList.addEventListener('dragover', (event) => {
      if (!draggedStepRow) {
        return;
      }
      event.preventDefault();
      const targetRow = event.target.closest('.step-row');
      if (!targetRow || targetRow === draggedStepRow) {
        return;
      }
      const targetRect = targetRow.getBoundingClientRect();
      const offset = event.clientY - targetRect.top;
      const shouldInsertBefore = offset < targetRect.height / 2;
      if (shouldInsertBefore) {
        stepsList.insertBefore(draggedStepRow, targetRow);
      } else {
        stepsList.insertBefore(draggedStepRow, targetRow.nextSibling);
      }
    });

    stepsList.addEventListener('drop', (event) => {
      event.preventDefault();
    });

    function buildDefinition() {
      const startLabel = sanitizeLabel(startInput.value, 'Start');
      const endLabel = sanitizeLabel(endInput.value, 'End');
      const stepRows = Array.from(stepsList.querySelectorAll('.step-row'));
      let stepCount = 0;
      let decisionCount = 0;

      const entries = stepRows.map((row) => {
        const type = row.dataset.type === 'decision' ? 'decision' : 'process';
        if (type === 'decision') {
          decisionCount += 1;
        } else {
          stepCount += 1;
        }

        const entryId = row.dataset.entryId || (type === 'decision' ? `decision${decisionCount}` : `step${stepCount}`);
        const input = row.querySelector('.step-input');
        const fallbackLabel = row.querySelector('.step-label')?.textContent?.trim() || entryId;
        const label = sanitizeLabel(input?.value, fallbackLabel);
        const assignments = collectAssignments(row);
        const inlineParts = [];
        if (assignments.role) {
          inlineParts.push(assignments.role);
        }
        const displayLabel = inlineParts.length > 0 ? `${label}\\n${inlineParts.join(' • ')}` : label;

        const buildBranch = (branchType) => {
          const stepsContainer = row.querySelector(`.branch-steps[data-branch="${branchType}"]`);
          const branchSteps = Array.from(stepsContainer?.querySelectorAll('.branch-step') || []).map((stepRow, index) => {
            const branchInput = stepRow.querySelector('.branch-step-input');
            const branchFallback = stepRow.querySelector('.branch-step-label')?.textContent?.trim() ||
              `${branchType === 'yes' ? 'Yes' : 'No'} ${index + 1}`;
            const branchLabel = sanitizeLabel(branchInput?.value, branchFallback);
            const branchAssignments = collectAssignments(stepRow);
            const branchInlineParts = [];
            if (branchAssignments.role) {
              branchInlineParts.push(branchAssignments.role);
            }
            const branchDisplayLabel =
              branchInlineParts.length > 0 ? `${branchLabel}\\n${branchInlineParts.join(' • ')}` : branchLabel;
            return {
              id: `${entryId}_${branchType}${index + 1}`,
              label: branchDisplayLabel,
              departmentLane: branchAssignments.department
            };
          });
          const targetSelect = row.querySelector(`.branch-target[data-branch="${branchType}"]`);
          const target = targetSelect?.value || 'finish';
          return { steps: branchSteps, target };
        };

        return {
          id: entryId,
          label: displayLabel,
          type,
          departmentLane: assignments.department,
          branches: type === 'decision' ? { yes: buildBranch('yes'), no: buildBranch('no') } : undefined
        };
      });

      const lines = [
        'flowchart TD',
        '  classDef start fill:#22c55e,color:#052e16,stroke:#16a34a,stroke-width:2px;',
        '  classDef step fill:#1f2937,color:#f8fafc,stroke:#334155,stroke-width:2px;',
        '  classDef decision fill:#fde68a,color:#78350f,stroke:#f59e0b,stroke-width:2px;',
        '  classDef finish fill:#fca5a5,color:#7f1d1d,stroke:#ef4444,stroke-width:2px;',
        '  classDef departmentLane fill:#082f49,color:#bae6fd,stroke:#38bdf8,stroke-width:1.5px,stroke-dasharray:6 4;',
        `  start((${startLabel})):::start`
      ];

      const linkStyleLines = [];
      let edgeIndex = 0;

      const nodeDeclarations = [];

      const registerNode = (nodeLine, departmentLabel) => {
        nodeDeclarations.push({ line: nodeLine, departmentLabel });
      };

      const addEdge = (from, to, options = {}) => {
        const { label, type = '-->', hidden } = options;
        const labelSegment = label ? `|${label}| ` : '';
        lines.push(`  ${from} ${type}${labelSegment}${to}`);
        if (hidden) {
          linkStyleLines.push(
            `  linkStyle ${edgeIndex} stroke-width:0px,stroke:transparent,color:transparent,opacity:0;`
          );
        }
        edgeIndex += 1;
      };

      entries.forEach(({ id, label, type, branches, departmentLane }) => {
        if (type === 'decision') {
          const decisionLine = `${id}{"${label}"}:::decision`;
          registerNode(decisionLine, departmentLane);
          branches.yes.steps.forEach((step) => {
            const branchLine = `${step.id}["${step.label}"]:::step`;
            registerNode(branchLine, step.departmentLane);
          });
          branches.no.steps.forEach((step) => {
            const branchLine = `${step.id}["${step.label}"]:::step`;
            registerNode(branchLine, step.departmentLane);
          });
        } else {
          const processLine = `${id}["${label}"]:::step`;
          registerNode(processLine, departmentLane);
        }
      });

      const departmentOrder = [];
      const departmentGroups = new Map();
      let departmentCounter = 0;

      nodeDeclarations.forEach(({ line, departmentLabel }) => {
        if (!departmentLabel) {
          lines.push(`  ${line}`);
          return;
        }

        if (!departmentGroups.has(departmentLabel)) {
          departmentCounter += 1;
          departmentGroups.set(departmentLabel, {
            laneId: `department_${departmentCounter}`,
            nodes: []
          });
          departmentOrder.push(departmentLabel);
        }

        departmentGroups.get(departmentLabel).nodes.push(line);
      });

      departmentOrder.forEach((departmentLabel) => {
        const { laneId, nodes } = departmentGroups.get(departmentLabel);
        lines.push(`  subgraph ${laneId}["${departmentLabel}"]`);
        lines.push('    direction TB');
        nodes.forEach((node) => {
          lines.push(`    ${node}`);
        });
        lines.push('  end');
        lines.push(`  class ${laneId} departmentLane;`);
      });

      lines.push(`  finish((${endLabel})):::finish`);

      if (entries.length === 0) {
        addEdge('start', 'finish');
        lines.push(...linkStyleLines);
        return lines.join('\n');
      }

      addEdge('start', entries[0].id);
      for (let i = 0; i < entries.length - 1; i += 1) {
        const current = entries[i];
        const next = entries[i + 1];
        if (current.type !== 'decision') {
          addEdge(current.id, next.id);
        }
      }

      const lastEntry = entries[entries.length - 1];
      if (lastEntry.type !== 'decision') {
        addEdge(lastEntry.id, 'finish');
      }

      entries
        .filter((entry) => entry.type === 'decision')
        .forEach((entry) => {
          const yesBranch = entry.branches.yes;
          const noBranch = entry.branches.no;

          const handleBranch = (branch, label) => {
            const branchSteps = branch.steps;
            const target = branch.target === 'finish' || !branch.target ? 'finish' : branch.target;
            if (branchSteps.length > 0) {
              addEdge(entry.id, branchSteps[0].id, { label });
              for (let i = 0; i < branchSteps.length - 1; i += 1) {
                addEdge(branchSteps[i].id, branchSteps[i + 1].id);
              }
              addEdge(branchSteps[branchSteps.length - 1].id, target);
            } else {
              addEdge(entry.id, target, { label });
            }
          };

          handleBranch(yesBranch, 'Yes');
          handleBranch(noBranch, 'No');
        });

      lines.push(...linkStyleLines);
      return lines.join('\n');
    }

    async function renderDiagram() {
      const definition = buildDefinition();
      diagram.innerHTML = '';

      if (!definition) {
        return;
      }

      try {
        const { svg } = await mermaid.render('diagram-' + Date.now(), definition);
        diagram.innerHTML = svg;
      } catch (error) {
        diagram.innerHTML = `<pre style="color:#f97316; white-space:pre-wrap;">${error.message}</pre>`;
      }
    }

    startInput.addEventListener('input', handleInputChange);
    endInput.addEventListener('input', handleInputChange);

    addStepButton.addEventListener('click', () => {
      const row = createStepRow();
      stepsList.appendChild(row);
      updateStepLabels();
      updateAssignmentOptions();
      renderDiagram();
      const input = row.querySelector('.step-input');
      if (input) {
        input.focus();
      }
    });

    addDecisionButton.addEventListener('click', () => {
      const row = createStepRow('', 'decision');
      stepsList.appendChild(row);
      updateStepLabels();
      updateAssignmentOptions();
      renderDiagram();
      const input = row.querySelector('.step-input');
      if (input) {
        input.focus();
      }
    });

    ['Plan', 'Build'].forEach((value) => {
      const row = createStepRow(value);
      stepsList.appendChild(row);
    });

    updateStepLabels();
    updateAssignmentOptions();
    renderDiagram();
  </script>
</body>
</html>
